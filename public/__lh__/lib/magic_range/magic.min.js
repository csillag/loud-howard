(function(){$.fn.xpath=function(t){var e;return e=this.map(function(){var e,n,r;for(r="",e=this;e&&1===e.nodeType&&e!==t;)n=$(e.parentNode).children(e.tagName).index(e)+1,n="["+n+"]",r="/"+e.tagName.toLowerCase()+n+r,e=e.parentNode;return r}),e.get()},$.fn.textNodes=function(){var t;return t=function(e){var n;if(e&&3!==e.nodeType){if(n=[],8!==e.nodeType)for(e=e.lastChild;e;)n.push(t(e)),e=e.previousSibling;return n.reverse()}return e},this.map(function(){return $.flatten(t(this))})},$.flatten=function(t){var e;return e=function(t){var n,r,o,i;for(r=[],o=0,i=t.length;i>o;o++)n=t[o],r=r.concat(n&&$.isArray(n)?e(n):n);return r},e(t)}}).call(this),function(){var t={}.hasOwnProperty,e=function(e,n){function r(){this.constructor=e}for(var o in n)t.call(n,o)&&(e[o]=n[o]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e};window.magic={},window.magic.Range={},window.magic.Range.sniff=function(t){return null!=t.commonAncestorContainer?new magic.Range.BrowserRange(t):"string"==typeof t.start?new magic.Range.SerializedRange(t):t.start&&"object"==typeof t.start?new magic.Range.NormalizedRange(t):(console.error(_t("Could not sniff range type")),!1)},window.magic.Range.nodeFromXPath=function(t,e){var n,r,o,i,s;return null==e&&(e=document),r=function(t,n){return null==n&&(n=null),document.evaluate("."+t,e,n,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},$.isXMLDoc(document.documentElement)?(n=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),i=r(t,n),i||(t=function(){var e,n,r,o;for(r=t.split("/"),o=[],e=0,n=r.length;n>e;e++)s=r[e],s&&-1===s.indexOf(":")?o.push(s.replace(/^([a-z]+)/,"xhtml:$1")):o.push(s);return o}().join("/"),o=document.lookupNamespaceURI(null),n=function(t){return"xhtml"===t?o:document.documentElement.getAttribute("xmlns:"+t)},i=r(t,n)),i):r(t)},window.magic.Range.RangeError=function(t){function n(t,e,r){this.type=t,this.message=e,this.parent=null!=r?r:null,n.__super__.constructor.call(this,this.message)}return e(n,t),n}(Error),window.magic.Range.BrowserRange=function(){function t(t){this.commonAncestorContainer=t.commonAncestorContainer,this.startContainer=t.startContainer,this.startOffset=t.startOffset,this.endContainer=t.endContainer,this.endOffset=t.endOffset}return t.prototype.normalize=function(){var t,e,n,r,o,i,s,a,f;if(this.tainted)return console.error(_t("You may only call normalize() once on a BrowserRange!")),!1;for(this.tainted=!0,i={},n={},f=["start","end"],s=0,a=f.length;a>s;s++){if(o=f[s],e=this[o+"Container"],r=this[o+"Offset"],1===e.nodeType){for(t=e.childNodes[r],e=t||e.childNodes[r-1],1!==e.nodeType||e.firstChild||(t=null,e=e.previousSibling);3!==e.nodeType;)e=e.firstChild;r=t?0:e.nodeValue.length}i[o]=e,i[o+"Offset"]=r}for(n.start=i.startOffset>0?i.start.splitText(i.startOffset):i.start,i.start===i.end?(i.endOffset-i.startOffset<n.start.nodeValue.length&&n.start.splitText(i.endOffset-i.startOffset),n.end=n.start):(i.endOffset<i.end.nodeValue.length&&i.end.splitText(i.endOffset),n.end=i.end),n.commonAncestor=this.commonAncestorContainer;1!==n.commonAncestor.nodeType;)n.commonAncestor=n.commonAncestor.parentNode;return new magic.Range.NormalizedRange(n)},t.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},t}(),window.magic.Range.NormalizedRange=function(){function t(t){this.commonAncestor=t.commonAncestor,this.start=t.start,this.end=t.end}return t.prototype.normalize=function(){return this},t.prototype.limit=function(t){var e,n,r,o,i,s;if(e=$.grep(this.textNodes(),function(e){return e.parentNode===t||$.contains(t,e.parentNode)}),!e.length)return null;for(this.start=e[0],this.end=e[e.length-1],r=$(this.start).parents(),s=$(this.end).parents(),o=0,i=s.length;i>o;o++)if(n=s[o],-1!==r.index(n)){this.commonAncestor=n;break}return this},t.prototype.serialize=function(t,e){var n,r,o;return r=function(n,r){var o,i,s,a,f,c,u,l;for(a=e?$(n).parents(":not("+e+")").eq(0):$(n).parent(),c=a.xpath(t)[0],f=a.textNodes(),i=f.slice(0,f.index(n)),s=0,u=0,l=i.length;l>u;u++)o=i[u],s+=o.nodeValue.length;return r?[c,s+n.nodeValue.length]:[c,s]},o=r(this.start),n=r(this.end,!0),new magic.Range.SerializedRange({start:o[0],end:n[0],startOffset:o[1],endOffset:n[1]})},t.prototype.text=function(){var t;return function(){var e,n,r,o;for(r=this.textNodes(),o=[],e=0,n=r.length;n>e;e++)t=r[e],o.push(t.nodeValue);return o}.call(this).join("")},t.prototype.textNodes=function(){var t,e,n,r;return n=$(this.commonAncestor).textNodes(),r=[n.index(this.start),n.index(this.end)],e=r[0],t=r[1],$.makeArray(n.slice(e,+t+1||9e9))},t.prototype.toRange=function(){var t;return t=document.createRange(),t.setStartBefore(this.start),t.setEndAfter(this.end),t},t}(),window.magic.Range.SerializedRange=function(){function t(t){this.start=t.start,this.startOffset=t.startOffset,this.end=t.end,this.endOffset=t.endOffset}return t.prototype.normalize=function(t){var e,n,r,o,i,s,a,f,c,u,l,d;for(i={},l=["start","end"],a=0,c=l.length;c>a;a++){o=l[a];try{r=magic.Range.nodeFromXPath(this[o],t)}catch(h){throw new magic.Range.RangeError(o,"Error while finding "+o+" node: "+this[o]+": "+h,h)}if(!r)throw new magic.Range.RangeError(o,"Couldn't find "+o+" node: "+this[o]);for(n=0,d=$(r).textNodes(),f=0,u=d.length;u>f;f++){if(s=d[f],n+s.nodeValue.length>=this[o+"Offset"]){i[o+"Container"]=s,i[o+"Offset"]=this[o+"Offset"]-n;break}n+=s.nodeValue.length}if(null==i[o+"Offset"])throw new Range.RangeError(""+o+"offset","Couldn't find offset "+this[o+"Offset"]+" in element "+this[o])}return e=null==document.compareDocumentPosition?function(t,e){return t.contains(e)}:function(t,e){return 16&t.compareDocumentPosition(e)},$(i.startContainer).parents().each(function(){return e(this,i.endContainer)?(i.commonAncestorContainer=this,!1):void 0}),new magic.Range.BrowserRange(i).normalize(t)},t.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},t.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},t}()}.call(this);