(function(){window.DomTextHiliter=function(){function e(e){var n;this.domMapper=e,n=document.createElement("span"),n.setAttribute("style","background-color: yellow; color: black; border-radius: 3px; box-shadow: 0 0 2px black;"),this.standardHilite=n,this.allActive={undo:{insert:[],remove:[]}}}return e.prototype.select=function(e,n){var t,o,r,l,i,u,s;if(null==n&&(n=null),null!=e){for(o=e.matches.length,null!=n?"number"==typeof n&&(n=[n]):n=function(){u=[];for(var e=0;o>=0?o>e:e>o;o>=0?e++:e--)u.push(e);return u}.apply(this),r=window.getSelection(),r.removeAllRanges(),s=[],l=0,i=n.length;i>l;l++)t=n[l],t>=0&&o>t&&s.push(function(n){var t;return t=e.matches[n],r.addRange(t.range)}(t));return s}},e.prototype.highlightSearchResults=function(e,n,t){var o;return null==n&&(n=null),null==t&&(t=null),o={ranges:e.matches},this.highlight(o,n,t),o},e.prototype.highlight=function(e,n,t){var o,r,l,i,u,s,a,d,h,p,c,f,g,v,m=this;if(null==n&&(n=null),null==t&&(t=null),null==n&&(n=this.standardHilite),l=e.ranges.length,null!=t)"number"==typeof t&&(t=[t]);else{if(!l)return;t=function(){v=[];for(var e=0;l>=0?l>e:e>l;l>=0?e++:e--)v.push(e);return v}.apply(this)}for(s=[],a=[],o={},d=function(n){var t,r,i,u,s;if(n>=0&&l>n){for(u=e.ranges[n].nodes,s=[],r=0,i=u.length;i>r;r++)t=u[r],s.push(function(e){var n,t;return n=e.element.pathInfo.path,null==(t=o[n])&&(o[n]=[]),o[n].push(e)}(t));return s}return console.log("Warning: match #"+n+" does not exist! (Allowed: ["+n+" - "+(l-1)+"])")},p=0,c=t.length;c>p;p++)r=t[p],d(r);h=function(e,t){var o,i,u,d,h,p,c,f,g,v,y,b,N,x;for(c=t[0].element.pathInfo.node,null==c&&(console.log("Node missing. Looking it up..."),c=m.domMapper.lookUpNode(t[0].element.pathInfo.path)),g=m.uniteRanges(function(){var e,n,o;for(o=[],e=0,n=t.length;n>e;e++)h=t[e],o.push({start:h.startCorrected,end:h.endCorrected,yields:h.yields});return o}()),o=c.cloneNode(),y=0,N=t.length;N>y;y++)h=t[y],h.element.pathInfo.node=o;if(l=c.data.length,u=1===g.length&&0===g[0].start&&g[0].end===l)return d=m.hilite(c,n),s.push({node:o,before:d}),a.push(d);for(r=0,i=!0,p=c,v=function(e){var t,u,h,c,f,g;return 0===e.start?(p=p.splitText(e.end),u=p.previousSibling,d=m.hilite(u,n),s.push({node:o,before:d}),a.push(d),r=e.end):e.end===l?(c=p.splitText(e.start-r),p=null,g=c.previousSibling,d=m.hilite(c,n),i&&s.push({node:o,before:g}),a.push(g),a.push(d)):(f=p.splitText(e.start-r),t=f.previousSibling,p=f.splitText(e.end-e.start),d=m.hilite(f,n),i&&s.push({node:o,before:t}),a.push(t),a.push(d),r=e.end),h=!1},b=0,x=g.length;x>b;b++)f=g[b],v(f);return null!=p?a.push(p):void 0};for(u in o)i=o[u],h(u,i);return e.undo={insert:s,remove:a},(f=this.allActive.undo.insert).push.apply(f,s),(g=this.allActive.undo.remove).push.apply(g,a),null},e.prototype.undo=function(e){var n,t,o,r,l,i,u,s;if(null!=(null!=e?e.undo:void 0)){for(u=e.undo.insert,o=0,l=u.length;l>o;o++)n=u[o],n.before.parentNode.insertBefore(n.node,n.before);for(e.undo.insert=[],s=e.undo.remove,r=0,i=s.length;i>r;r++)t=s[r],t.parentNode.removeChild(t);return e.undo.remove=[]}},e.prototype.clean=function(){return console.log("Hilite cleanup"),this.undo(this.allActive),console.log("Done")},e.prototype.hilite=function(e,n){var t,o;return o=e.parentNode,null==o?(console.log("Warning: hilited node has no parent!"),console.log(e),void 0):(t=n.cloneNode(),t.appendChild(e.cloneNode()),e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e),t)},e.prototype.compareRanges=function(e,n){return e.start<n.start?-1:e.start>n.start?1:e.end<n.end?-1:e.end>n.end?1:0},e.prototype.uniteRanges=function(e){var n,t,o,r,l,i,u,s;for(l=[],delete o,s=e.sort(this.compareRanges),i=0,u=s.length;u>i;i++)r=s[i],o!==void 0&&null!==o&&o.end>=r.start?r.end>o.end&&(n=r.end-o.end,t=r.yields.substr(r.yields.length-n,n),o.yields=o.yields+t,o.end=r.end):l.push(o={start:r.start,end:r.end,yields:r.yields});return l},e}()}).call(this);