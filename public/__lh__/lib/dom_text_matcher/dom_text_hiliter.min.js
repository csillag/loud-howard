(function(){window.DomTextHiliter=function(){function e(e){var n;this.domMapper=e,n=document.createElement("span"),n.setAttribute("style","background-color: yellow; color: black; border-radius: 3px; box-shadow: 0 0 2px black;"),this.standardHilite=n,this.allActive={undo:{insert:[],remove:[]}}}return e.prototype.select=function(e,n){var t,r,o,l,i,u,s;if(null==n&&(n=null),null!=e){for(r=e.matches.length,null!=n?"number"==typeof n&&(n=[n]):n=function(){u=[];for(var e=0;r>=0?r>e:e>r;r>=0?e++:e--)u.push(e);return u}.apply(this),o=window.getSelection(),o.removeAllRanges(),s=[],l=0,i=n.length;i>l;l++)t=n[l],t>=0&&r>t&&s.push(function(n){var t;return t=e.matches[n],o.addRange(t.realRrange)}(t));return s}},e.prototype.highlightSearchResults=function(e,n,t){var r;return null==n&&(n=null),null==t&&(t=null),r={sections:e.matches},this.highlight(r,n,t),r},e.prototype.highlight=function(e,n,t){var r,o,l,i,u,s,a,d,h,p,c,f,g,v,m=this;if(null==n&&(n=null),null==t&&(t=null),null==n&&(n=this.standardHilite),l=e.sections.length,null!=t)"number"==typeof t&&(t=[t]);else{if(!l)return;t=function(){v=[];for(var e=0;l>=0?l>e:e>l;l>=0?e++:e--)v.push(e);return v}.apply(this)}for(s=[],a=[],r={},d=function(n){var t,o,i,u,s;if(n>=0&&l>n){for(u=e.sections[n].mappings,s=[],o=0,i=u.length;i>o;o++)t=u[o],s.push(function(e){var n,t;return n=e.element.path,null==(t=r[n])&&(r[n]=[]),r[n].push(e)}(t));return s}return console.log("Warning: section #"+n+" does not exist! (Allowed: ["+n+" - "+(l-1)+"])")},p=0,c=t.length;c>p;p++)o=t[p],d(o);h=function(e,t){var r,i,u,d,h,p,c,f,g,v,y,b,N,C,w;for(v=t[0].element.node,null==v&&(console.log("Node missing. Looking it up..."),v=m.domMapper.lookUpNode(t[0].element.path)),i=m.uniteCharRanges(function(){var e,n,r;for(r=[],e=0,n=t.length;n>e;e++)f=t[e],r.push({full:f.full,start:f.startCorrected,end:f.endCorrected,yields:f.yields});return r}()),u=v.cloneNode(),b=0,C=t.length;C>b;b++)f=t[b],f.element.node=u;if(c=v.nodeType===Node.ELEMENT_NODE&&"img"===v.tagName.toLowerCase(),c?h=!0:(l=v.data.length,h=1===i.length&&(i[0].full||0===i[0].start&&i[0].end===l)),h)return p=m.hilite(v,n),s.push({node:u,before:p}),a.push(p);for(o=0,d=!0,g=v,y=function(e){var t,r,i,h,c,f;return 0===e.start?(g=g.splitText(e.end),r=g.previousSibling,p=m.hilite(r,n),s.push({node:u,before:p}),a.push(p),o=e.end):e.end===l?(h=g.splitText(e.start-o),g=null,f=h.previousSibling,p=m.hilite(h,n),d&&s.push({node:u,before:f}),a.push(f),a.push(p)):(c=g.splitText(e.start-o),t=c.previousSibling,g=c.splitText(e.end-e.start),p=m.hilite(c,n),d&&s.push({node:u,before:t}),a.push(t),a.push(p),o=e.end),i=!1},N=0,w=i.length;w>N;N++)r=i[N],y(r);return null!=g?a.push(g):void 0};for(u in r)i=r[u],h(u,i);return e.undo={insert:s,remove:a},(f=this.allActive.undo.insert).push.apply(f,s),(g=this.allActive.undo.remove).push.apply(g,a),null},e.prototype.undo=function(e){var n,t,r,o,l,i,u,s;if(null!=(null!=e?e.undo:void 0)){for(u=e.undo.insert,r=0,l=u.length;l>r;r++)n=u[r],n.before.parentNode.insertBefore(n.node,n.before);for(e.undo.insert=[],s=e.undo.remove,o=0,i=s.length;i>o;o++)t=s[o],t.parentNode.removeChild(t);return e.undo.remove=[]}},e.prototype.clean=function(){return console.log("Hilite cleanup"),this.undo(this.allActive),console.log("Done")},e.prototype.hilite=function(e,n){var t,r;if(r=e.parentNode,null==r)throw Error("Hilited node has no parent!");return t=n.cloneNode(),t.appendChild(e.cloneNode()),e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e),t},e.prototype.compareCharRanges=function(e,n){return e.start<n.start?-1:e.start>n.start?1:e.end<n.end?-1:e.end>n.end?1:0},e.prototype.uniteCharRanges=function(e){var n,t,r,o,l,i,u,s,a;for(i=[],delete l,a=e.sort(this.compareCharRanges),u=0,s=a.length;s>u;u++)r=a[u],r.full&&(o=r),l!==void 0&&null!==l&&l.end>=r.start?r.end>l.end&&(n=r.end-l.end,t=r.yields.substr(r.yields.length-n,n),l.yields=l.yields+t,l.end=r.end):i.push(l={start:r.start,end:r.end,yields:r.yields});return null!=o&&(i=[o]),i},e}()}).call(this);