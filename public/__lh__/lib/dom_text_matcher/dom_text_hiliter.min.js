(function(){window.DomTextHiliter=function(){function e(e){var n;this.domMapper=e,n=document.createElement("span"),n.setAttribute("style","background-color: yellow; color: black; border-radius: 3px; box-shadow: 0 0 2px black;"),this.standardHilite=n,this.allActive={undo:{insert:[],remove:[]}}}return e.prototype.select=function(e,n){var t,r,o,l,i,u,s;if(null==n&&(n=null),null!=e){for(r=e.matches.length,null!=n?"number"==typeof n&&(n=[n]):n=function(){u=[];for(var e=0;r>=0?r>e:e>r;r>=0?e++:e--)u.push(e);return u}.apply(this),o=window.getSelection(),o.removeAllRanges(),s=[],l=0,i=n.length;i>l;l++)t=n[l],t>=0&&r>t&&s.push(function(n){var t;return t=e.matches[n],o.addRange(t.range)}(t));return s}},e.prototype.highlightSearchResults=function(e,n,t){var r;return null==n&&(n=null),null==t&&(t=null),r={ranges:e.matches},this.highlight(r,n,t),r},e.prototype.highlight=function(e,n,t){var r,o,l,i,u,s,d,a,h,p,c,f,g,v,m=this;if(null==n&&(n=null),null==t&&(t=null),null==n&&(n=this.standardHilite),l=e.ranges.length,null!=t)"number"==typeof t&&(t=[t]);else{if(!l)return;t=function(){v=[];for(var e=0;l>=0?l>e:e>l;l>=0?e++:e--)v.push(e);return v}.apply(this)}for(s=[],d=[],r={},a=function(n){var t,o,i,u,s;if(n>=0&&l>n){for(u=e.ranges[n].nodes,s=[],o=0,i=u.length;i>o;o++)t=u[o],s.push(function(e){var n,t;return n=e.element.path,null==(t=r[n])&&(r[n]=[]),r[n].push(e)}(t));return s}return console.log("Warning: match #"+n+" does not exist! (Allowed: ["+n+" - "+(l-1)+"])")},p=0,c=t.length;c>p;p++)o=t[p],a(o);h=function(e,t){var r,i,u,a,h,p,c,f,g,v,y,b,N,x;for(c=t[0].element.node,null==c&&(console.log("Node missing. Looking it up..."),c=m.domMapper.lookUpNode(t[0].element.path)),g=m.uniteRanges(function(){var e,n,r;for(r=[],e=0,n=t.length;n>e;e++)h=t[e],r.push({start:h.startCorrected,end:h.endCorrected,yields:h.yields});return r}()),r=c.cloneNode(),y=0,N=t.length;N>y;y++)h=t[y],h.element.node=r;if(l=c.data.length,u=1===g.length&&0===g[0].start&&g[0].end===l)return a=m.hilite(c,n),s.push({node:r,before:a}),d.push(a);for(o=0,i=!0,p=c,v=function(e){var t,u,h,c,f,g;return 0===e.start?(p=p.splitText(e.end),u=p.previousSibling,a=m.hilite(u,n),s.push({node:r,before:a}),d.push(a),o=e.end):e.end===l?(c=p.splitText(e.start-o),p=null,g=c.previousSibling,a=m.hilite(c,n),i&&s.push({node:r,before:g}),d.push(g),d.push(a)):(f=p.splitText(e.start-o),t=f.previousSibling,p=f.splitText(e.end-e.start),a=m.hilite(f,n),i&&s.push({node:r,before:t}),d.push(t),d.push(a),o=e.end),h=!1},b=0,x=g.length;x>b;b++)f=g[b],v(f);return null!=p?d.push(p):void 0};for(u in r)i=r[u],h(u,i);return e.undo={insert:s,remove:d},(f=this.allActive.undo.insert).push.apply(f,s),(g=this.allActive.undo.remove).push.apply(g,d),null},e.prototype.undo=function(e){var n,t,r,o,l,i,u,s;if(null!=(null!=e?e.undo:void 0)){for(u=e.undo.insert,r=0,l=u.length;l>r;r++)n=u[r],n.before.parentNode.insertBefore(n.node,n.before);for(e.undo.insert=[],s=e.undo.remove,o=0,i=s.length;i>o;o++)t=s[o],t.parentNode.removeChild(t);return e.undo.remove=[]}},e.prototype.clean=function(){return console.log("Hilite cleanup"),this.undo(this.allActive),console.log("Done")},e.prototype.hilite=function(e,n){var t,r;if(r=e.parentNode,null==r)throw Error("Hilited node has no parent!");return t=n.cloneNode(),t.appendChild(e.cloneNode()),e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e),t},e.prototype.compareRanges=function(e,n){return e.start<n.start?-1:e.start>n.start?1:e.end<n.end?-1:e.end>n.end?1:0},e.prototype.uniteRanges=function(e){var n,t,r,o,l,i,u,s;for(l=[],delete r,s=e.sort(this.compareRanges),i=0,u=s.length;u>i;i++)o=s[i],r!==void 0&&null!==r&&r.end>=o.start?o.end>r.end&&(n=o.end-r.end,t=o.yields.substr(o.yields.length-n,n),r.yields=r.yields+t,r.end=o.end):l.push(r={start:o.start,end:o.end,yields:o.yields});return l},e}()}).call(this);