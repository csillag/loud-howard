(function(){window.DomTextMapper=function(){function t(){this.setRealRoot(),window.DomTextMapper.instances.push(this)}var e,o,n;return n=!0,o=!0,e=32,t.instances=[],t.changed=function(t,e){var o,n,r,s;if(null==e&&(e="no reason"),0!==this.instances.length){for(s=this.instances,n=0,r=s.length;r>n;n++)o=s[n],o.performUpdateOnNode(t);return null}},t.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},t.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},t.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},t.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},t.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},t.prototype.documentChanged=function(){return this.lastDOMChange=this.timestamp()},t.prototype.scan=function(){var t,e,o,n,r;return this.domStableSince(this.lastScanned)?this.path:(o=this.timestamp(),this.saveSelection(),this.path={},this.collectPathsForNode(this.pathStartNode),n=this.timestamp(),console.log("Path traversal took "+(n-o)+" ms."),e=this.getPathTo(this.pathStartNode),t=this.path[e].node,this.collectStrings(t,e,null,0,0),this.restoreSelection(),this.lastScanned=this.timestamp(),this.corpus=this.path[e].content,r=this.timestamp(),console.log("Phase II of data collecting "+(r-n)+" ms."),this.path)},t.prototype.selectPath=function(t,e){var o,n,r;return null==e&&(e=!1),o=this.path[t],n=null!=(r=o.node)?r:this.lookUpNode(o.path),this.selectNode(n,e)},t.prototype.performUpdateOnNode=function(t,e){var o,n,r,s,a,i,l,h,d,u,c,p,f,g;if(null==e&&(e=!1),null==t)throw Error("Called performUpdate with a null node!");if(null!=this.path){if(c=this.timestamp(),e||this.saveSelection(),l=this.getPathTo(t),h=this.path[l],null==h)return this.performUpdateOnNode(t.parentNode,!0),e||this.restoreSelection(),void 0;if(h.node===t&&h.content===this.getNodeContent(t,!1)){u=l+"/",d=r,d=[],g=this.path;for(r in g)o=g[r],this.stringStartsWith(r,u)&&d.push(r);for(p=0,f=d.length;f>p;p++)r=d[p],delete this.path[r];if(this.collectPathsForNode(t),h.node===this.pathStartNode)console.log("Ended up rescanning the whole doc."),this.collectStrings(t,l,null,0,0);else{if(a=this.parentPath(l),i=this.path[a],null==i)throw Error("While performing update on node "+l+", no path info found for parent path: "+a);n=this.path[l].start-i.start,this.collectStrings(t,l,i.content,i.start,n)}}else{if(h.node===this.pathStartNode)throw console.log("I can not go up, since I'm already at path start node. Barking out."),Error("Can not keep up with the changes, since even the node configured as path start node was replaced.");s=null!=t.parentNode?t.parentNode:(a=this.parentPath(l),this.lookUpNode(a)),this.performUpdateOnNode(s,!0)}return e?void 0:this.restoreSelection()}},t.prototype.getInfoForPath=function(t){var e;if(null==this.path)throw Error("Can't get info before running a scan() !");if(e=this.path[t],null==e)throw Error("Found no info for path '"+t+"'!");return e},t.prototype.getInfoForNode=function(t){return this.getInfoForPath(this.getPathTo(t))},t.prototype.getMappingsForRanges=function(t){var e,o,n,r,s;for(s=[],n=0,r=t.length;r>n;n++)o=t[n],s.push(e=this.getMappingsForRange(o.start,o.end));return s},t.prototype.getContentForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].content},t.prototype.getLengthForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.path[t].length},t.prototype.getContentForRange=function(t,e,o){return null==o&&(o=null),this.getContentForPath(o).substr(t,e-t)},t.prototype.getContextForRange=function(t,o,n){var r,s,a,i,l;return null==n&&(n=null),r=this.getContentForPath(n),i=Math.max(0,t-e),a=t-i,s=r.substr(i,a),l=r.substr(o,a),[s.trim(),l.trim()]},t.prototype.getMappingsForRange=function(t,e){var o,n,r,s,a,i,l,h,d,u,c,p,f,g,m,N,S=this;if(null==t||null==e)throw Error("start and end is required!");this.scan(),l=[],N=this.path;for(h in N)i=N[h],i.atomic&&this.regions_overlap(i.start,i.end,t,e)&&function(o){var n,r;return r={element:o},n=o.start>=t&&e>=o.end,n?(r.full=!0,r.wanted=o.content):o.start>=t?(r.end=e-o.start,r.wanted=o.content.substr(0,r.end)):e>=o.end?(r.start=t-o.start,r.wanted=o.content.substr(r.start)):(r.start=t-o.start,r.end=e-o.start,r.wanted=o.content.substr(r.start,r.end-r.start)),S.computeSourcePositions(r),r.yields=o.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected),l.push(r)}(i);if(0===l.length)throw Error("No matches found for ["+t+":"+e+"]!");return d=this.rootWin.document.createRange(),p=l[0],f=p.element.node,m=p.element.path,g=p.startCorrected,p.full?(d.setStartBefore(f),c=m):(d.setStart(f,g),c=m+":"+g),n=l[l.length-1],r=n.element.node,a=n.element.path,s=n.endCorrected,n.full?(d.setEndAfter(r),o=a):(d.setEnd(r,s),o=a+":"+s),u={nodes:l,range:d,rangeInfo:{startPath:m,startOffset:g,startInfo:c,endPath:a,endOffset:s,endInfo:o},safeParent:d.commonAncestorContainer}},t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.stringStartsWith=function(t,e){return e===t.substr(0,e.length)},t.prototype.parentPath=function(t){return t.substr(0,t.lastIndexOf("/"))},t.prototype.domChangedSince=function(t){return null!=this.lastDOMChange&&null!=t?this.lastDOMChange>t:!0},t.prototype.domStableSince=function(t){return!this.domChangedSince(t)},t.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},t.prototype.getPathTo=function(t){var e,o,n;for(n="";t!==this.rootNode;){for(e=0,o=t;o;)o.nodeName===t.nodeName&&e++,o=o.previousSibling;n=this.getProperNodeName(t)+(e>1?"["+e+"]":"")+"/"+n,t=t.parentNode}return n=(null!=this.rootNode.ownerDocument?"./":"/")+n,n=n.replace(/\/$/,"")},t.prototype.collectPathsForNode=function(t){var e,o,n,r,s,a;if(o=this.getNodeContent(t,!1),o.length&&(n=this.getPathTo(t),this.path[n]={path:n,content:o,length:o.length,node:t}),t.hasChildNodes())for(a=t.childNodes,r=0,s=a.length;s>r;r++)e=a[r],this.collectPathsForNode(e);return null},t.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},t.prototype.regions_overlap=function(t,e,o,n){return n>t&&e>o},t.prototype.lookUpNode=function(t){var e,o,n,r;return e=null!=(r=this.rootNode.ownerDocument)?r:this.rootNode,n=e.evaluate(t,this.rootNode,null,0,null),o=n.iterateNext()},t.prototype.saveSelection=function(){var t,e,o,n,r;if(null!=this.oldRanges)throw console.log("Selection saved at:"),console.log(this.selectionSaved),Error("Selection already saved!");for(e=this.rootWin.getSelection(),t=o=0,n=e.rangeCount;n>=0?n>o:o>n;t=n>=0?++o:--o)this.oldRanges=e.getRangeAt(t);switch(e.rangeCount){case 0:null==(r=this.oldRanges)&&(this.oldRanges=[]);break;case 1:this.oldRanges=[this.oldRanges]}try{throw Error("Selection was saved here")}catch(s){return this.selectionSaved=s.stack}},t.prototype.restoreSelection=function(){var t,e,o,n,r;if(null==this.oldRanges)throw Error("No selection to restore.");for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.oldRanges,o=0,n=r.length;n>o;o++)t=r[o],e.addRange(t);return delete this.oldRanges},t.prototype.selectNode=function(t,e){var r,s,a,i,l;if(null==e&&(e=!1),a=this.rootWin.getSelection(),a.removeAllRanges(),s=this.rootWin.document.createRange(),n&&t.nodeType===Node.ELEMENT_NODE&&("thead"===(l=t.tagName.toLowerCase())||"tbody"===l)&&t.hasChildNodes()?(r=t.childNodes,s.setStartBefore(r[0]),s.setEndAfter(r[r.length-1]),a.addRange(s)):o&&t.nodeType===Node.TEXT_NODE&&"table"===t.parentNode.tagName.toLowerCase()||(s.setStartBefore(t),s.setEndAfter(t),a.addRange(s)),e){for(i=t;null==i.scrollIntoViewIfNeeded;)i=i.parentNode;i.scrollIntoViewIfNeeded()}return a},t.prototype.readSelectionText=function(t){return t||(t=this.rootWin.getSelection()),(""+t).trim().replace(/\n/g," ").replace(/[ ][ ]+/g," ")},t.prototype.getNodeSelectionText=function(t,e){var o,n;return null==e&&(e=!0),e&&this.saveSelection(),o=this.selectNode(t),n=this.readSelectionText(o),e&&this.restoreSelection(),n},t.prototype.computeSourcePositions=function(t){var e,o,n,r,s,a,i,l,h,d;for(d=t.element.node.data.replace(/\n/g," "),s=t.element.content,r=null!=t.start?t.start:0,o=null!=t.end?t.end:s.length,l=0,n=0;null==h||null==i;)a=d[l],e=s[n],a===e&&(n===r&&(h=l),n++,n===o&&(i=l+1)),l++;return t.startCorrected=h,t.endCorrected=i,null},t.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},t.prototype.collectStrings=function(t,e,o,n,r){var s,a,i,l,h,d,u,c,p,f,g,m,N,S;if(null==o&&(o=null),null==n&&(n=0),null==r&&(r=0),g=this.path[e],h=null!=g?g.content:void 0,null==h||""===h)return r;if(N=null!=o?o.indexOf(h,r):r,-1===N)return r;if(d=N+h.length,s=!t.hasChildNodes(),g.start=n+N,g.end=n+d,g.atomic=s,!s)for(l=t.childNodes,u=0,m=0,S={};l.length>u;)a=l[u],p=this.getProperNodeName(a),f=S[p],c=null!=f?f+1:1,S[p]=c,i=e+"/"+p+(c>1?"["+c+"]":""),m=this.collectStrings(a,i,h,n+N,m),u++;return d},t}()}).call(this);