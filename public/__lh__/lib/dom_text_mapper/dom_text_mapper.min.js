(function(){window.DomTextMapper=function(){function t(){this.setRealRoot(),this.restrictToSerializable(!1)}return t.prototype.restrictToSerializable=function(t){return null==t&&(t=!0),this.restricted=t},t.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},t.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},t.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},t.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},t.prototype.documentChanged=function(){return this.lastDOMChange=this.timestamp()},t.prototype.getAllPaths=function(){var t,e,n,o,r;if(this.domStableSince(this.lastCollectedPaths))return this.restricted?this.cleanPaths:this.allPaths;if(o=this.timestamp(),this.saveSelection(),this.allPaths={},this.collectPathsForNode(this.pathStartNode),this.restoreSelection(),this.lastCollectedPaths=this.timestamp(),console.log("Path traversal took "+(this.lastCollectedPaths-o)+" ms."),this.restricted){this.cleanPaths={},r=this.allPaths;for(n in r)e=r[n],t=$.extend({},e),delete t.node,this.cleanPaths[n]=t;return this.cleanPaths}return this.allPaths},t.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},t.prototype.selectPath=function(t,e){var n,o;return null==e&&(e=!1),n=this.allPaths[t],this.selectNode(null!=(o=n.node)?o:this.lookUpNode(n.path))},t.prototype.scan=function(t){var e;return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),t===this.scannedPath&&this.domStableSince(this.lastScanned)?void 0:(this.getAllPaths(),e=this.allPaths[t].node,this.mappings={},this.saveSelection(),this.collectStrings(e,t,null,0,0),this.restoreSelection(),this.scannedPath=t,this.lastScanned=this.timestamp(),this.corpus=this.mappings[t].pathInfo.content,null)},t.prototype.performUpdateOnNode=function(t,e){var n,o,r,s,a,i,l,h,d,c,p,u,f,g,m;if(null==e&&(e=!1),null==t)throw Error("Called performUpdate with a null node!");if(u=this.timestamp(),e||this.saveSelection(),h=this.getPathTo(t),d=this.allPaths[h],d.node===t&&d.content===this.getNodeContent(t)){p=h+"/",c=r,c=[],m=this.allPaths;for(r in m)n=m[r],this.stringStartsWith(r,p)&&c.push(r);for(f=0,g=c.length;g>f;f++)r=c[f],delete this.mappings[r],delete this.allPaths[r];this.collectPathsForNode(t),i=this.parentPath(h),l=this.allPaths[i],s=this.mappings[i],o=this.mappings[h].start-s.start,this.collectStrings(t,h,l.content,s.start,o)}else{if(d.node===this.pathStartNode)throw console.log("I can not go up, since I'm already at path start node. Barking out."),Error("Can not keep up with the changes, since even the node configured as path start node was replaced.");a=null!=t.parentNode?t.parentNode:(i=this.parentPath(h),this.lookUpNode(i)),this.performUpdateOnNode(a,!0)}return e?void 0:this.restoreSelection()},t.prototype.getRangeForPath=function(t){var e;return e=this.mappings[t],this.restricted&&(e=$.extend({},e),e.pathInfo=$.extend({},e.pathInfo),delete e.pathInfo.node),e},t.prototype.getMappingsForRanges=function(t,e){var n,o,r,s,a,i;return null==e&&(e=null),s=function(){var n,o,s;for(s=[],n=0,o=t.length;o>n;n++)i=t[n],s.push(r=this.getMappingsForRange(i.start,i.end,e));return s}.call(this),this.restricted&&(s=function(){var t,e,i;for(i=[],t=0,e=s.length;e>t;t++)r=s[t],n=$.extend({},r),delete n.range,n.nodes=function(){var t,e,r,s;for(r=n.nodes,s=[],t=0,e=r.length;e>t;t++)a=r[t],o=$.extend({},a),o.element=$.extend({},o.element),o.element.pathInfo=$.extend({},o.element.pathInfo),delete o.element.pathInfo.node,s.push(o);return s}(),i.push(n);return i}()),s},t.prototype.getMappingsForRange=function(t,e,n){var o,r,s,a,i,l,h,d,c,p,u,f,g,m,N,P,S=this;if(null==n&&(n=null),null==t||null==e)throw Error("start and end is required!");if(null!=n&&this.scan(n),null==this.scannedPath)throw Error("Can not run getMappingsFor() without existing mappings. Either supply a path to scan, or call scan() beforehand!");h=[],P=this.mappings;for(d in P)l=P[d],l.atomic&&this.regions_overlap(l.start,l.end,t,e)&&function(n){var o,r;return r={element:n},o=n.start>=t&&e>=n.end,o?(r.full=!0,r.wanted=n.content):n.start>=t?(r.end=e-n.start,r.wanted=n.pathInfo.content.substr(0,r.end)):e>=n.end?(r.start=t-n.start,r.wanted=n.pathInfo.content.substr(r.start)):(r.start=t-n.start,r.end=e-n.start,r.wanted=n.pathInfo.content.substr(r.start,r.end-r.start)),S.computeSourcePositions(r),r.yields=n.pathInfo.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected),h.push(r)}(l);if(0===h.length)throw Error("No matches found!");return c=this.rootWin.document.createRange(),f=h[0],g=f.element.pathInfo.node,N=f.element.pathInfo.path,m=f.startCorrected,f.full?(c.setStartBefore(g),u=N):(c.setStart(g,m),u=N+":"+m),r=h[h.length-1],s=r.element.pathInfo.node,i=r.element.pathInfo.path,a=r.endCorrected,r.full?(c.setEndAfter(s),o=i):(c.setEnd(s,a),o=i+":"+a),p={nodes:h,range:c,rangeInfo:{startPath:N,startOffset:m,startInfo:u,endPath:i,endOffset:a,endInfo:o},safeParent:c.commonAncestorContainer}},t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.stringStartsWith=function(t,e){return e===t.substr(0,e.length)},t.prototype.parentPath=function(t){return t.substr(0,t.lastIndexOf("/"))},t.prototype.domChangedSince=function(t){return null!=this.lastDOMChange&&null!=t?this.lastDOMChange>t:!0},t.prototype.domStableSince=function(t){return!this.domChangedSince(t)},t.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},t.prototype.getPathTo=function(t){var e,n,o;for(o="";t!==this.rootNode;){for(e=0,n=t;n;)n.nodeName===t.nodeName&&e++,n=n.previousSibling;o=this.getProperNodeName(t)+(e>1?"["+e+"]":"")+"/"+o,t=t.parentNode}return o=(null!=this.rootNode.ownerDocument?"./":"/")+o,o=o.replace(/\/$/,"")},t.prototype.collectPathsForNode=function(t){var e,n,o,r;if(r=this.getPathTo(t),n=this.getNodeContent(t,!1),n.length&&(this.allPaths[r]={path:r,content:n,length:n.length,node:t}),t.hasChildNodes)for(e=t.childNodes,o=0;e.length>o;)this.collectPathsForNode(e[o]),o++;return null},t.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},t.prototype.regions_overlap=function(t,e,n,o){return o>t&&e>n},t.prototype.lookUpNode=function(t){var e,n,o,r;return e=null!=(r=this.rootNode.ownerDocument)?r:this.rootNode,o=e.evaluate(t,this.rootNode,null,0,null),n=o.iterateNext()},t.prototype.saveSelection=function(){var t,e,n,o,r;for(e=this.rootWin.getSelection(),t=n=0,o=e.rangeCount;o>=0?o>n:n>o;t=o>=0?++n:--n)this.oldRanges=e.getRangeAt(t);switch(e.rangeCount){case 0:return null!=(r=this.oldRanges)?r:this.oldRanges=[];case 1:return this.oldRanges=[this.oldRanges]}},t.prototype.restoreSelection=function(){var t,e,n,o,r,s;for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.oldRanges,s=[],n=0,o=r.length;o>n;n++)t=r[n],s.push(e.addRange(t));return s},t.prototype.selectNode=function(t,e){var n,o,r;if(null==e&&(e=!1),o=this.rootWin.getSelection(),o.removeAllRanges(),n=this.rootWin.document.createRange(),n.setStartBefore(t),n.setEndAfter(t),o.addRange(n),e){for(r=t;null==r.scrollIntoViewIfNeeded;)r=r.parentNode;r.scrollIntoViewIfNeeded()}return o},t.prototype.getNodeSelectionText=function(t,e){var n,o;return null==e&&(e=!0),e&&this.saveSelection(),n=this.selectNode(t),o=(""+n).trim().replace(/\n/g," ").replace(/[ ][ ]+/g," "),e&&this.restoreSelection(),o},t.prototype.computeSourcePositions=function(t){var e,n,o,r,s,a,i,l,h,d;for(d=t.element.pathInfo.node.data.replace(/\n/g," "),s=t.element.pathInfo.content,r=null!=t.start?t.start:0,n=null!=t.end?t.end:s.length,l=0,o=0;null==h||null==i;)a=d[l],e=s[o],a===e&&(o===r&&(h=l),o++,o===n&&(i=l+1)),l++;return t.startCorrected=h,t.endCorrected=i,null},t.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},t.prototype.collectStrings=function(t,e,n,o,r){var s,a,i,l,h,d,c,p,u,f,g,m,N,P;if(null==n&&(n=null),null==o&&(o=0),null==r&&(r=0),g=this.allPaths[e],h=null!=g?g.content:void 0,null==h||""===h)return r;if(N=null!=n?n.indexOf(h,r):r,-1===N)return r;if(d=N+h.length,s=!t.hasChildNodes(),this.mappings[e]={pathInfo:g,start:o+N,end:o+d,atomic:s},this.declareMappings&&console.log("Found mappings for ["+this.mappings[e].start+":"+this.mappings[e].end+"]: "+g.content),!s)for(l=t.childNodes,c=0,m=0,P={};l.length>c;)a=l[c],u=this.getProperNodeName(a),f=P[u],p=null!=f?f+1:1,P[u]=p,i=e+"/"+u+(p>1?"["+p+"]":""),m=this.collectStrings(a,i,h,o+N,m),c++;return d},t}()}).call(this);