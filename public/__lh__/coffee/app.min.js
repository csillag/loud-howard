(function(){var t;t=function(){function t(t){this.rootScope=t}return t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.set=function(t,e){return this.rootScope.waitIndicatorTitle=t,this.rootScope.waitIndicatorText=e,this.lastUpdated=this.timestamp(),$("#wait-indicator-dialog").modal("show")},t.prototype.olderThan=function(t){return this.timestamp()-this.lastUpdated>t},t.prototype.finished=function(){return $("#wait-indicator-dialog").modal("hide")},t}(),angular.module("waitIndicator",[]).service("waitIndicator",["$rootScope",t])}).call(this),function(){angular.module("loudHoward.services",["domTextMatcher","waitIndicator"])}.call(this),function(){angular.module("loudHoward.directives",[])}.call(this),function(){angular.module("loudHoward.filters",[])}.call(this),function(){var t,e=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};t=function(){function t(t,l,g,p,f,v,m){var w=this;l.get(h+"/forget_proxy"),window.wtfscope=t,t.init=function(){var e=this;return this.domMapper=f.getInstance(),this.loadSettings=!1,this.documentExplanation="Loading of this document started with the specified URL, but we are not detecting whether it was redirected somewhere else. So the loaded document might not correspond to the specified URL.",this.$watch("selectedPath",function(){return e.prepareSelectedPath()}),this.wait=m,this.hiliter=v,this.candidateMinLength=500,this.numAnnotations=10,this.distribution="uniform",this.minLength=3,this.maxLength=50,this.selectWholeWords=!0,this.devMode="localhost"===document.location.hostname,this.targetServer="h3",this.devMode&&i&&(this.wantedURL="http://en.wikipedia.org/wiki/Criteria_of_truth"),this.devMode&&a?(t.loginUser="csillag",t.loginPass="lemmehelp"):void 0},t.init(),t.getExcerpt=function(t,e){var n;return null==e&&(e=d),n=e/2,e>=t.length?t:t.substr(0,n)+" [...] "+t.substr(t.length-n)},t.splitURL=function(){var t,e,n,o,a,r,i;return t=document.createElement("a"),t.href=this.wantedURL,r=t.protocol,n=t.hostname,a=""===t.port?"80":t.port,o=t.pathname,i=t.search,e=t.hash,[n,a,o+i+e]},t.loadWithProxy=function(){var t,e,n,o,a=this;return o=this.splitURL(),t=o[0],n=o[1],e=o[2],l.get(h+"/setup_proxy/"+t+"/"+n).success(function(t){return"success"===t.status?(a.shouldLoad=e,a.sourceURL=h+"/loading",a.tryingToLoad=!0):(console.log(t),alert("Failed to configure proxy: "+t.message))})},t.urlEdited=function(){var t=this;return null==this.wantedURL?(alert("Please enter a valid URL!"),void 0):(delete this.paths,delete this.offeredPaths,delete this.selectedPath,console.log("Wanted URL is: "+this.wantedURL),this.wait.set("Loading…","Please wait while the specified document is loaded!"),g(function(){return t.loadWithProxy()}))},t.getIframe=function(){return window.document.getElementById("loud-howard-article-box")},t.loadedOK=function(){var t;return t=this.getIframe().contentDocument.documentElement.innerHTML,"<head></head><body></body>"!==t},t.getLoadedPath=function(){var t;return t=this.getIframe().contentDocument.location,t.pathname+t.search+t.hash},t.fixSize=function(){var e;return e=$(".navbar").outerHeight()+5,$("#article-container").css("top",e+"px"),g(function(){return t.fixSize()},1e3)},t.fixSize(),window.loudHowardUrlLoaded=function(){return t.$apply(function(){return null!=t.tryingToLoad?(delete t.tryingToLoad,null!=t.shouldLoad?(t.sourceURL=t.shouldLoad,t.tryingToLoad=!0,delete t.shouldLoad,void 0):(console.log("URL loaded."),l.get(h+"/get_redirection").success(function(e){var n,o,a,r,i;return null!=e&&""!==e&&(console.log("Was server-redirected to "+e),w.tryingToLoad=!0,t.wantedURL=e),i=t.splitURL(),o=i[0],a=i[1],r=i[2],n=t.getLoadedPath(),n!==r?t.wantedURL="http://"+o+("80"!==a?":"+a:"")+n:void 0}),t.loadedOK()?(t.wait.set("Parsing…","Please wait while the document is being analyzed!"),t.domMapper.setRootIframe("loud-howard-article-box"),t.domMapper.documentChanged(),delete t.paths,delete t.selectedPath,t.checkPaths()):(t.wait.finished(),alert("Failed to load document. Sorry. Probably has something to do with cookies vs proxying.")))):void 0})},t.checkPaths=function(){var t=this;return g(function(){var n;return t.paths||(t.paths=t.domMapper.scan()),t.filterPathCandidates(),n=t.selectedPath,e.call(t.offeredPaths,n)>=0?t.prepareSelectedPath():t.selectedPath=t.domMapper.getDefaultPath()})},t.filterPathCandidates=function(){var t,e;return this.offeredPaths=function(){var n,o;n=this.paths,o=[];for(e in n)t=n[e],t.length>=this.candidateMinLength&&o.push(e);return o}.call(this),0===this.offeredPaths.length?(this.candidateMinLength=Math.max.apply(Math,function(){var n,o;n=this.paths,o=[];for(e in n)t=n[e],o.push(t.length);return o}.call(this)),this.filterPathCandidates()):void 0},t.getSummary=function(t){var e,n,o;return n=this.paths[t],e=this.getExcerpt(n.content),o=t+" ('"+e+"'; "+n.length+" chars)"},t.prepareSelectedPath=function(){return null!=this.selectedPath?(console.log("Chosen "+this.selectedPath+"."),this.hiliter.undo(this.task),delete this.annotations,delete this.anchors,"/HTML/BODY"!==this.selectedPath&&this.domMapper.selectPath(this.selectedPath,!0),this.wait.finished(),this.devMode&&n?this.generateAnnotations():void 0):void 0},t.getRandomInt=function(t,e){return t+Math.floor(Math.random()*(e-t+1))},t.makeUniformDistribution=function(){var t,e,n,o,a,r;for(e={},n=o=1,a=this.numAnnotations;a>=1?a>=o:o>=a;n=a>=1?++o:--o)t=this.getRandomInt(this.minLength,this.maxLength),null==(r=e[t])&&(e[t]=0),e[t]+=1;return e},t.getLengthDistribution=function(){switch(this.distribution){case"uniform":return this.makeUniformDistribution();case"gauss":return this.makeGaussDistribution();case"boltzmann":return this.makeBoltzmannDistribution();default:return alert("Unknown distribution requested: '"+this.distribution+"'.")}},t.getLengths=function(){var t,e,n,o,a,r;n=[],r=this.getLengthDistribution();for(e in r)for(o=r[e],t=a=1;o>=1?o>=a:a>=o;t=o>=1?++a:--a)n.push(parseInt(e));return n},t.generateAnnotations=function(){var t,e,n,o,a;return this.hiliter.undo(this.task),a=this.domMapper.getInfoForPath(this.selectedPath),o=a.start,t=a.content,n=a.length,this.wait.set("Generating…","Please wait while generating the annotations!"),this.anchors=function(){var t,n,o,a;for(o=this.getLengths(),a=[],t=0,n=o.length;n>t;t++)e=o[t],a.push({len:e});return a}.call(this),this.calculateAnchor(0,t,n,o)},t.calculateAnchor=function(e,n,o,a){var r,i=this;return r=this.anchors.length-e,this.wait.olderThan(1e3)&&this.wait.set("Generating…","Please wait while calculating anchor positions! ("+r+" more to go.)"),g(function(){var h,l;for(h=t.anchors[e];null==h.mappings;)try{if(h.start=i.getRandomInt(0,o-h.len),h.end=h.start+h.len,t.selectWholeWords){for(;h.start>0&&-1===s.indexOf(n[h.start-1]);)h.start-=1;for(;o>h.end&&-1===s.indexOf(n[h.end]);)h.end+=1}h.len=h.end-h.start,h.text=t.domMapper.getContentForCharRange(h.start,h.end,i.selectedPath),""!==h.text.trim()&&(h.startGlobal=h.start+a,h.endGlobal=h.end+a,h.mappings=t.domMapper.getMappingsForCharRange(h.startGlobal,h.endGlobal),l=t.domMapper.getContextForCharRange(h.startGlobal,h.endGlobal),h.prefix=l[0],h.suffix=l[1],h.magicRange=t.getSerializedMagicRange(h.mappings.realRange),t.domMapper.performUpdateOnNode(h.mappings.safeParent))}catch(d){console.log(d),console.log("Oops.. chosen a charRange which has a mystery source: ["+h.startGlobal+":"+h.endGlobal+"]: '"+h.text+"'. That won't work, for now. Just choose something else.")}return 1!==r?t.calculateAnchor(e+1,n,o,a):t.allAnchorsCalculated()})},t.allAnchorsCalculated=function(){var t=this;return this.wait.set("Generating…","All anchor positions calculated. Finishing up annotations..."),g(function(){var e,n,o,a;for(console.log("Now re-calculating native mapping info for updated DOM structure..."),a=t.anchors,n=0,o=a.length;o>n;n++)e=a[n],e.mappings=t.domMapper.getMappingsForCharRange(e.startGlobal,e.endGlobal);return console.log("Done."),t.annotations=function(){var t,n,o,a;for(o=this.anchors,a=[],t=0,n=o.length;n>t;t++)e=o[t],a.push(this.createAnnotation(e));return a}.call(t),t.wait.finished(),t.task={sections:function(){var t,n,o,a;for(o=this.anchors,a=[],t=0,n=o.length;n>t;t++)e=o[t],a.push({mappings:e.mappings.mappings});return a}.call(t)},t.hiliter.highlight(t.task)}),this.devMode&&r?this.saveAnnotations():void 0},t.getSerializedMagicRange=function(t){var e;return e=new magic.Range.BrowserRange(t),e.serialize()},t.getXPathRangeSelector=function(t,e){var n;return n={source:t,type:"xpath range",startXpath:e.start.substr(c),endXpath:e.end.substr(c),startOffset:e.startOffset,endOffset:e.endOffset}},t.createAnnotation=function(e){var n;return n=""+new Date,{updated:n,created:n,uri:this.wantedURL,target:{id:"",selector:[t.getXPathRangeSelector(this.wantedURL,e.magicRange),{source:this.wantedURL,type:"position",start:e.start,end:e.end},{source:this.wantedURL,type:"context+quote",exact:e.text,prefix:e.prefix,suffix:e.suffix}]},user:"acct:"+this.serverUser+"@"+this.serverHost+":"+this.serverPort,text:"All I have to say about '"+e.text+"' is that this is an auto-generated annotation, so I have no idea about it.",permissions:{read:[],admin:[],update:[],"delete":[]}}},t.getLoginStatus=function(){var t=this;return l.get(h+"/login_status").success(function(e){var n;return t.serverProtocol=e.protocol,t.serverHost=e.host,t.serverPort=e.port,t.serverUser=e.user,n="none"!==t.serverHost?[t.serverUser+"/"+t.serverHost+":"+t.serverPort,e.token]:[null,null],t.persona=n[0],t.token=n[1],null==t.persona&&t.devMode&&a&&t.tryLogin(),null!=t.persona&&t.devMode&&o?t.urlEdited():void 0})},t.logout=function(){var t=this;return l.post(h+"/logout").success(function(){return t.getLoginStatus()}),this.hiliter.undo(this.task),delete this.offeredPaths,delete this.annotations,delete this.anchors,delete this.paths,delete this.sourceURL},t.login=function(t,e,n,o,a){var r,i=this;return r={protocol:t,host:e,port:n,user:o,pass:a},l.post(h+"/login",r).success(function(t){switch(t.status){case"connection error":return alert("Can not connect to server.");case"bad password":return alert("Invalid username or password.");case"internal error":return alert("Could not log you in due to an internal error. Sorry.");case"success":return i.getLoginStatus();default:return alert("Could not unterstand the server's answer. Sorry")}})},t.tryLogin=function(){var t,e,n,o;return o=function(){switch(this.targetServer){case"localhost":return["http","localhost",5e3];case"h3":return["http","h3.nolmecolindor.com",80];case"dev":return["https","dev.hypothes.is",443];case"test":return["https","test.hypothes.is",443];default:return[null,null,null]}}.call(this),n=o[0],t=o[1],e=o[2],null!=t?this.login(n,t,e,this.loginUser,this.loginPass):console.log("Unknown target server "+this.targetServer)},t.annotationSaved=function(){return this.pendingSaveCount-=1,this.wait.set("Saving…","Please wait while saving the annotations! ("+this.pendingSaveCount+" more to go.)"),0===this.pendingSaveCount?(this.wait.finished(),this.hiliter.undo(this.task),delete this.annotations,delete this.anchors):void 0},t.saveAnnotation=function(t){var e,n=this;return console.log("Sending save request..."),e=this.serverProtocol+"://"+this.serverHost+":"+this.serverPort+"/api/current/annotations",l.post(e,t).success(function(){return console.log("OK."),n.annotationSaved()}).error(function(t,e,o,a){switch(console.log("Error!"),e){case 0:alert("Could not connect to server!");break;case 401:console.log(t),alert("Access denied. That means an authentication problem with the server...");break;default:console.log("Unknown error while saving annotation:"),console.log(t),console.log(e),console.log(o),console.log(a)}return n.annotationSaved()})},t.saveAnnotations=function(){var e,n,o,a;for(this.wait.set("Saving…","Please wait while saving the annotations!"),console.log("Saving annotations to "+this.serverHost),this.pendingSaveCount=this.annotations.length,l.defaults.headers.post["x-annotator-auth-token"]=this.token,a=[],e=n=0,o=this.annotations.length;o>=0?o>n:n>o;e=o>=0?++n:--n)a.push(function(e){return g(function(){return t.saveAnnotation(t.annotations[e])},1e3*e*u)}(e));return a},t.getLoginStatus()}var n,o,a,r,i,s,h,l,d,c,u;return a=!1,i=!0,o=!0,n=!1,r=!1,s=" ,.!?+-/*()$%&;:",l="__lh__",h="/"+l,c="/html[1]/body[1]".length,u=1,d=64,t.$inject=["$scope","$http","$timeout","$document","domTextMapper","domTextHiliter","waitIndicator"],t}(),angular.module("loudHoward.controllers",[]).controller("GenController",t)}.call(this);